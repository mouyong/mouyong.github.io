---
title: æ‰‹æŠŠæ‰‹å¸¦ä½ é€šè¿‡ä¸€ç•ªæ“ä½œé‡Šæ”¾æœåŠ¡å™¨ 17G ç£ç›˜ç©ºé—´
date: 2020-06-28 14:57:42
categories: è¿ç»´
tags:
- è¿ç»´
english_title: How-to-release-17g-disk-space-of-server-through-some-operations?
---

# æ‰‹æŠŠæ‰‹å¸¦ä½ æ’æŸ¥é‡åˆ°æœåŠ¡å™¨æ— å¯ç”¨ç£ç›˜ç©ºé—´é—®é¢˜ä¸å¤„ç†

## èƒŒæ™¯

åœ¨ç«¯åˆæœŸé—´ï¼Œçªç„¶æ”¶åˆ°æ¶ˆæ¯è¯´ï¼Œsentry æœåŠ¡æ— æ³•è®¿é—®äº†ï¼Œè¯·æ±‚æ€»æ˜¯å‡ºç° 502 é¡µé¢å“åº”ã€‚æ£ç€å¿å¿‘ä¸å®‰çš„å¿ƒæƒ… â™¥ å¼€å§‹äº†æ’æŸ¥ä¹‹æ—…ã€‚

## æŸ¥å› 

1. ä»å“ªä¸‹æ‰‹ï¼Ÿ

- æœåŠ¡å™¨çš„å†…å­˜æ»¡äº†å—ï¼Ÿ
a. å¦‚æœæ²¡æœ‰å†…å­˜äº†ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¹Ÿç™»å½•ä¸ä¸Šã€‚
b. å¦‚æœæ²¡æœ‰å†…å­˜ï¼Œé‚£ä¹ˆè®¿é—®ä¹Ÿå°†ä¸ä¼šå‡ºç° 502 å“åº”ï¼Œè€Œæ˜¯æ‰“ä¸å¼€æœåŠ¡äº†ã€‚
c. ç™»å½•æœåŠ¡å™¨åæ‰§è¡Œ `free -h` æŸ¥çœ‹ï¼ŒæœåŠ¡å™¨çš„å†…å­˜è¿˜æœ‰ä¸€å®šçš„å‰©ä½™ï¼Œå¥½çš„ğŸ‘Œï¼Œè¿™ä¸ªç¡®è®¤å®‰å…¨ã€‚

- ä¸ºå•¥ä¼šçªç„¶åœæ­¢è¿è¡Œå‘¢ï¼Ÿ
sentry æœåŠ¡æ˜¯é‡‡ç”¨å®˜æ–¹æä¾›çš„æ­å»ºæ–¹æ¡ˆä¸­çš„ docker æ–¹å¼ä½œä¸ºæœåŠ¡è¿è¡ŒäºæœåŠ¡å™¨ä¸Šï¼Œå‰å‡ å¤©éƒ½è¿˜å¥½å¥½çš„ã€‚

2. å…ˆæ£€æŸ¥ä¸€ä¸‹æœåŠ¡å™¨çš„ç›¸å…³ sentry æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚

`docker ps -a` å¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œsentry ç›¸å…³çš„æœåŠ¡ä¸­ï¼Œæœ‰ 3 ä¸ªç›¸å…³å®¹å™¨å¤„äº Restaring çŠ¶æ€ã€‚

![æœåŠ¡å™¨ sentry è¿è¡Œæƒ…å†µ](æœåŠ¡å™¨-sentry-è¿è¡Œæƒ…å†µ.png)

3. æœåŠ¡ä¸ºå•¥æ— æ³•å¯åŠ¨ï¼Œä¸ºå•¥ä¸€ç›´å¤„äº Restaring çŠ¶æ€ï¼Ÿ

é€šè¿‡å¯¹å®¹å™¨çš„è¿›è¡Œæ—¥å¿—çš„é€ä¸ªæŸ¥çœ‹ï¼Œåˆæ¢ç«¯å€ª

`docker-compose logs -tail 200 postgres`: **No space left on device**ï¼Œé‡å¯æœåŠ¡æ—¶ï¼Œå› æ— å¯ç”¨å‰©ä½™ç©ºé—´ï¼Œæ‰€ä»¥æ— æ³•å¯åŠ¨äº†ã€‚

![æœåŠ¡å™¨æ— å¯ç”¨ç©ºé—´æç¤º](æœåŠ¡å™¨æ— å¯ç”¨ç©ºé—´æç¤º.png)

4. æœåŠ¡å™¨çœŸçš„æ²¡æœ‰å¯ç”¨å‰©ä½™ç©ºé—´äº†å—ï¼Ÿ

é€šè¿‡è¿è¡Œå‘½ä»¤ `df -h /`ï¼Œå¾—çŸ¥æœåŠ¡å™¨çš„ç£ç›˜ç©ºé—´ä½¿ç”¨æ¥è¿‘ 100%ï¼ŒçœŸçš„æ²¡æœ‰ç©ºé—´äº†ã€‚

![æœåŠ¡å™¨ç©ºé—´ä½¿ç”¨æƒ…å†µ](æœåŠ¡å™¨ç©ºé—´ä½¿ç”¨æƒ…å†µ.png)

## çŸ¥æœ

é€šè¿‡ä¸€ç•ªæ’æŸ¥ï¼Œæˆ‘ä»¬çŸ¥é“äº† sentry æœåŠ¡æ— æ³•è¿è¡Œçš„åŸå› äº†ã€‚é‚£æ¥ä¸‹æ¥è¯¥å¯¹æœåŠ¡å™¨ç£ç›˜è¿›è¡Œæ¸…ç†äº†ã€‚

1. docker æœåŠ¡æ˜¯å¦æœ‰é™åˆ¶æ—¥å¿—è¾“å‡ºé€‰é¡¹ï¼Ÿ

é€šè¿‡ `cat /etc/docker/daemon.json` æŸ¥çœ‹æœåŠ¡å™¨å¯åŠ¨é…ç½®å¾—çŸ¥ï¼Œæ—¥å¿—é©±åŠ¨ä½¿ç”¨çš„æ˜¯ json-fileï¼Œæ—¥å¿—é…ç½®é€‰é¡¹ä¸ºæ¯ä¸ªå®¹å™¨ä¿ç•™ 3ä»½æ—¥å¿—æ–‡ä»¶ï¼Œæ¯ä»½æ–‡ä»¶æœ€å¤§å¤§å°ä¸º 100Mã€‚

```
{
  "registry-mirrors": ["https://oifw9ovt.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {"max-size": "50m", "max-file": "3"}
}
```

2. sentry æœåŠ¡æ˜¯å¦æœ‰é…ç½®æ—¥å¿—è¾“å‡ºé€‰é¡¹ï¼Ÿ

é€šè¿‡ `cat /path/to/onpremise/docker-compose.yml` æŸ¥çœ‹ sentry æœåŠ¡çš„ docker-compose ç¼–æ’æ–‡ä»¶ï¼Œå¯ä»¥å¾—çŸ¥ä¸ docker æœåŠ¡ä¸€è‡´ï¼Œæ—¥å¿—é©±åŠ¨ä½¿ç”¨çš„æ˜¯ json-fileï¼Œæ—¥å¿—é…ç½®é€‰é¡¹ä¸ºæ¯ä¸ªå®¹å™¨ä¿ç•™ 3ä»½æ—¥å¿—æ–‡ä»¶ï¼Œæ¯ä»½æ–‡ä»¶æœ€å¤§å¤§å°ä¸º 100Mã€‚

![æœåŠ¡å™¨-docker-æ—¥å¿—è®¾ç½®](æœåŠ¡å™¨-docker-æ—¥å¿—è®¾ç½®.png)

3. æ˜¯ docker ç›¸å…³çš„æœåŠ¡è¾“å‡ºçš„æ—¥å¿—å¤ªå¤šå—ï¼Ÿ

a. æ˜¯ sentry è¿è¡Œæ—¶é—´è¿‡é•¿ï¼ŒæŠ¥é”™å¤ªå¤šå¯¼è‡´æ•°æ®åº“ä¸­çš„æ•°æ®è¿‡å¤šå—ï¼Ÿ

é€šè¿‡ä¸€ç•ªæœç´¢ï¼Œæ‰¾åˆ°äº†æ–‡ç«  [Sentry æœåŠ¡ç£ç›˜å æ»¡ æ¸…é™¤postgresqlæ–¹æ³•](https://juejin.im/post/5cb93b576fb9a068726e1f5f)

å¯¹æ–‡ç« çš„é˜…è¯»åå‘ç°ï¼Œsentry å·²æ— æ³•è¿è¡Œï¼Œä¸èƒ½é€šè¿‡æ‰‹åŠ¨æ¸…ç†æ—¥å¿—æ¥å‡å°‘ç£ç›˜ç©ºé—´ï¼Œä¸è¿‡å…³äºè‡ªåŠ¨æ¸…ç†è¶…è¿‡ä¸ƒå¤©çš„è®°å½•è¿˜æ˜¯æœ‰ç‚¹ç”¨å¤„ï¼Œé‚å‚è€ƒæ–‡ç« åŠ ä¸Šäº†ç›¸å…³é…ç½®ã€‚

b. é…ç½® docker æœåŠ¡å™¨æ—¥å¿—è½®è½¬

åˆä¸€ç•ªæœç´¢åï¼Œä¼¼ä¹çœ‹åˆ°äº†å¸Œæœ›ï¼Œ[Kubernetesä¹‹å®¹å™¨æ•°æ®å†™æ»¡ç£ç›˜è§£å†³æ–¹æ³•](https://www.yp14.cn/2020/01/12/Kubernetes%E4%B9%8B%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%86%99%E6%BB%A1%E7%A3%81%E7%9B%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/)

å‚è€ƒæ–‡ç« ä¸­çš„å…·ä½“ä¼˜åŒ–æ–¹æ³•ï¼Œæ£€æŸ¥ docker æœåŠ¡ï¼Œå·²æœ‰ç›¸å…³é…ç½®ã€‚

4. åˆ°åº•æ˜¯ä»€ä¹ˆå ç”¨äº†æœåŠ¡å™¨ 40G çš„ç£ç›˜ç©ºé—´?

a. æ–‡ä»¶ç³»ç»Ÿç£ç›˜è¢«è°ä½¿ç”¨äº†ï¼Ÿ

é€šè¿‡ `df -lh | sort -h` æŸ¥çœ‹ç£ç›˜å½“å‰å ç”¨æƒ…å†µæ’åº

å¾—çŸ¥ `/var/lib/docker/aufs/mnt/` å ç”¨äº†å¤§å¤šæ•°çš„ç©ºé—´ã€‚

b. ç£ç›˜ä¸­å“ªäº›ç›®å½•å ç”¨äº†è¾ƒå¤§çš„ç©ºé—´ï¼Ÿ

é€šè¿‡ `du -hd 2 / | sort -hr` æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ

å¾—çŸ¥ /var ç›®å½•å ç”¨äº† 23G çš„ç£ç›˜ç©ºé—´ã€‚

![æ ¹ç›®å½•ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ](æ ¹ç›®å½•ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ.png)

c. å¯¹æ¯ä¸ªç©ºé—´å ç”¨å¤§äº 1G çš„ç›®å½•è¿›è¡Œå­ä¸€çº§ç›®å½•çš„ç›®å½•ä½¿ç”¨æƒ…å†µç»Ÿè®¡

å¾—çŸ¥ /var/log ç›®å½•æ—¥å¿—ä½¿ç”¨äº† 17G çš„ç©ºé—´ï¼Œå•å•äº‹ä»¶è®°å½•ç›‘æ§ç¨‹åºæ—¥å¿—å°±è¾¾åˆ°äº† 16G çš„ç©ºé—´ã€‚

![var-ç›®å½•ç©ºé—´ä½¿ç”¨æƒ…å†µ](var-ç›®å½•ç©ºé—´ä½¿ç”¨æƒ…å†µ.png)
![var-logç›®å½•ç©ºé—´ä½¿ç”¨æƒ…å†µ](var-log-ç›®å½•ç©ºé—´ä½¿ç”¨æƒ…å†µ.png)

5. å¼€å§‹æ¸…ç†æ—¥å¿—å§

å›  log ç›®å½•ä¸‹éƒ¨åˆ†æ—¥å¿—æœ‰ç‚¹ç‰¹æ®Šï¼Œä¸æ˜¯å­˜æ–‡æœ¬æ–‡ä»¶ï¼Œæ•…å‚è€ƒ [linux log åŠå¦‚ä½•æ¸…é™¤log](https://www.jianshu.com/p/ad59f4a938e9)ï¼Œå¯¹æ—¥å¿—åšäº†ä¸€äº›æ¸…ç†ï¼š

a. åˆ é™¤ /var/log ä¸‹çš„æ—¥å¿—å‹ç¼©åŒ…
`rm -rf /var/log/*.gz`

b. åˆ é™¤ /var/log è½®è½¬æ—¥å¿—
`rm -rf /var/log/*.1`

c. æ¸…ç©ºå†…æ ¸æ—¥å¿—
`cat /dev/null > /var/log/dmesg`

d. æ¸…ç©º Linux æ“ä½œç³»ç»Ÿå¸¸è§çš„ç³»ç»Ÿå’ŒæœåŠ¡é”™è¯¯ä¿¡æ¯
`cat /dev/null > /var/log/messages`

e. æ¸…ç©ºäº‹ä»¶è®°å½•ç›‘æ§ç¨‹åºæ—¥å¿—
`cat /dev/null > /var/log/syslog`

f. æ¸…ç† journal æ—¥å¿—
```
# æŸ¥çœ‹ç£ç›˜å ç”¨
du -hd 2 /var/log | sort -hr
journalctl --disk-usage

# æ¸…ç†æ—¥å¿—
journalctl --vacuum-size=10M

# åªä¿ç•™ä¸€å‘¨çš„æ—¥å¿—
journalctl --vacuum-time=1w

# å†æ¬¡æŸ¥çœ‹ç£ç›˜å ç”¨
journalctl --disk-usage
du -hd 2 /var/log | sort -hr
```

g. åˆ é™¤ 24å°æ—¶å‰ä¸‹è½½çš„é•œåƒ
`docker image prune -a --filter "until=24h"`

## æœ«ï¼šå•æœåŠ¡å™¨é‡Šæ”¾äº† 17G çš„ç£ç›˜ç©ºé—´

æœ€åï¼Œä¸€ç•ªæ“ä½œåï¼Œå•æœåŠ¡å™¨é‡Šæ”¾äº† 17G çš„ç£ç›˜ç©ºé—´ã€‚

![æ—¥å¿—æ¸…ç†å](æ—¥å¿—æ¸…ç†å.png)

## æ€»ç»“

- **æ“ä½œéœ€è°¨æ…**
- å¤šå¤šåˆ©ç”¨æ’åºï¼Œèƒ½ä¾¿äºæ’æŸ¥é—®é¢˜ã€‚
- ææ—©åšå¥½ç›¸åº”å·¥ä½œï¼Œèƒ½å‡å°‘ä¸´æ—¶å¤„ç†é—®é¢˜çš„å¯èƒ½æ€§

**ç»™å¤§å®¶å‡ ä¸ªæ–¹ä¾¿ä½¿ç”¨çš„å°å‘½ä»¤**ï¼š

```shell
# æŸ¥çœ‹æœåŠ¡å™¨å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h

# æŸ¥çœ‹ç£ç›˜å½“å‰å ç”¨æƒ…å†µ
df -h /

# æŸ¥çœ‹ç£ç›˜å½“å‰å ç”¨æƒ…å†µæ’åº
df -lh | sort -h

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨ç»Ÿè®¡
du -hd 2 / | sort -hr

composer clearcache

yarn clean cache --all

npm clean cahce --force

snap list --all | awk '/disabled/{print $1, $3}' |
   while read snapname revision; do
       snap remove "$snapname" --revision="$revision"
   done
```
